<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Суммы и обслуживание — простой калькулятор</title>
  <style>
    :root{--bg:#f7f8fb;--card:#ffffff;--accent:#5988ff;--danger:#da3c3f;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:900px;margin:18px auto;padding:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    h1{font-size:18px;margin:0 0 12px}

    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-row{display:flex;gap:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=number], input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
    button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .wide-btn{width:100%;padding:14px 16px;border-radius:12px;font-size:16px;display:block;text-align:center}
    @media (min-width:720px){
      .wide-btn{font-size:16px}
    }
    button.secondary{background:#eef2ff;color:var(--accent);border:1px solid rgba(36,99,255,0.08)}
    button.danger{background:var(--danger)}

    .controls{display:flex;gap:8px;align-items:end}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}

    .history{max-height:360px;overflow:auto;padding:8px;border-radius:8px;border:1px dashed #eef2f7}
    .entry{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:#fbfdff;margin-bottom:8px;align-items:center}
    .entry .meta{display:flex;gap:10px;align-items:center}
    .badge{padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px}
    .badge.mul{background:#eef7ff;color:var(--accent)}
    .badge.div{background:#fff7eb;color:#b45309}
    .small{font-size:13px;color:var(--muted)}

    .summary{background:linear-gradient(180deg,#ffffff,#fbfdff);padding:12px;border-radius:10px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .big{font-size:20px;font-weight:700}

    footer.note{margin-top:12px;color:var(--muted);font-size:13px}

    @media (max-width:720px){
      .form{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .wrap{padding:12px}
    }
    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px) {
      .form {
        grid-template-columns: 1fr 1fr;
      }
      .form > div:last-child {
        grid-column: 1 / -1;
      }
    }
    .icon-btn {
  background: #5988ff72;
  border: none;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 10px;
  border-radius: 6px;
  transition: background 0.2s;
}
.icon-btn:hover {
  background: rgba(0,0,0,0.06);
}
.icon-btn.danger {
  background: #5988ff72;
}
.icon-btn.danger:hover {
  background: rgba(0,0,0,0.06);
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Калькулятор сумм и обслуживания</h1>
      <div class="form" id="controls">
        <div>
          <label for="price">Цена</label>
          <input id="price" type="number" min="0" step="0.01" placeholder="Например 1000" />
        </div>
        <div>
          <label for="qty">Количество</label>
          <input id="qty" type="number" min="1" step="1" placeholder="Например 2" />
        </div>
        <div style="grid-column:1/3;display:flex;gap:8px;flex-direction:column">
          <button id="btn-mul" class="wide-btn">Добавить x </button>
          <button id="btn-div" class="secondary wide-btn">Разделить и суммировать /</button>
          <button id="btn-clear" class="danger">Очистить всё</button>
        </div>
      </div>

      <div class="grid">
        <div>
<div style="margin-top:12px">
  <label for="service">Обслуживание (%)</label>
  <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
    <input id="service" type="number" min="0" max="100" step="0.1" placeholder="Например 10" style="flex:1" />
    <!-- Кнопка применить -->
    <button id="btn-apply-service" class="icon-btn" title="Применить">
      ✅
    </button>
    <!-- Кнопка сбросить -->
    <button id="btn-reset-service" class="icon-btn danger" title="Сбросить">
      ❌
    </button>
  </div>
</div>

          <h3 style="margin-top:12px;margin-bottom:6px">История</h3>
          <div class="history" id="history"></div>
        </div>

        <div>
          <div class="summary">
            <div class="row"><div class="small">Сумма (без обслуживания)</div><div id="sum" class="big">0</div></div>
            <div class="row"><div class="small">Обслуживание</div><div id="serviceAmount" class="small">0</div></div>
            <div style="height:1px;background:#eef2ff;margin:8px 0;border-radius:2px"></div>
            <div class="row"><div class="small">Итог (с обслуживанием)</div><div id="total" class="big">0</div></div>
          </div>
          <div style="margin-top:12px;text-align:center">
            <button id="btn-calc" class="wide-btn">Рассчитать</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    class SumManager {
      constructor() {
        this.entries = [];
        this.service = 0; // проценты
        this._nextId = 1;
      }

      addMultiply(price, qty) {
        const value = Number(price) * Number(qty);
        if (!isFinite(value)) throw new Error('Невалидная сумма');
        this.entries.push({ id: this._nextId++, type: 'mul', price: Number(price), qty: Number(qty), value });
      }

      addDivideThenSum(price, qty) {
        if (Number(qty) === 0) throw new Error('Количество не может быть 0');
        const value = Number(price) / Number(qty);
        if (!isFinite(value)) throw new Error('Невалидная сумма');
        this.entries.push({ id: this._nextId++, type: 'div', price: Number(price), qty: Number(qty), value });
      }

      setService(percent) {
        this.service = Number(percent) || 0;
      }

      remove(id) {
        this.entries = this.entries.filter(e => e.id !== id);
      }

      clear() {
        this.entries = [];
        this._nextId = 1;
      }

      getSum() {
        return this.entries.reduce((s, e) => s + e.value, 0);
      }

      getServiceAmount() {
        return this.getSum() * (this.service / 100);
      }

      calculate() {
        const sum = this.getSum();
        const serviceAmount = this.getServiceAmount();
        const total = sum + serviceAmount; // ПРИБАВЛЯЕМ
        return { sum, serviceAmount, total };
      }
    }

    const mgr = new SumManager();

    const el = id => document.getElementById(id);
    const priceIn = el('price');
    const qtyIn = el('qty');
    const btnMul = el('btn-mul');
    const btnDiv = el('btn-div');
    const historyEl = el('history');
    const sumEl = el('sum');
    const serviceIn = el('service');
    const serviceAmountEl = el('serviceAmount');
    const totalEl = el('total');
    const btnCalc = el('btn-calc');
    const btnApplyService = el('btn-apply-service');
    const btnResetService = el('btn-reset-service');
    const btnClear = el('btn-clear');

    function fmt(n){
      return Number(n).toLocaleString('ru-RU', {maximumFractionDigits:2,minimumFractionDigits: n % 1 === 0 ? 0 : 2});
    }

    function renderHistory(){
      historyEl.innerHTML = '';
      if (mgr.entries.length === 0) {
        historyEl.innerHTML = '<div style="padding:12px;color:var(--muted)">История пуста</div>';
        return;
      }

      mgr.entries.slice().reverse().forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry';
        const badge = document.createElement('div');
        badge.className = 'badge ' + (entry.type === 'mul' ? 'mul' : 'div');
        badge.textContent = entry.type === 'mul' ? 'x' : '/';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const p = document.createElement('div');
        p.innerHTML = `<div style="font-weight:600">${fmt(entry.value)}</div><div class="small">цена ${fmt(entry.price)} • кол-во ${entry.qty}</div>`;
        meta.appendChild(badge);
        meta.appendChild(p);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '8px';
        const del = document.createElement('button');
        del.textContent = 'Удалить';
        del.className = 'secondary';
        del.onclick = () => { mgr.remove(entry.id); renderAll(); };
        right.appendChild(del);

        div.appendChild(meta);
        div.appendChild(right);
        historyEl.appendChild(div);
      });
    }

    function renderSummary(){
      const { sum, serviceAmount, total } = mgr.calculate();
      sumEl.textContent = fmt(sum);
      serviceAmountEl.textContent = fmt(serviceAmount);
      totalEl.textContent = fmt(total);
    }

    function renderAll(){
      renderHistory();
      renderSummary();
    }

    btnMul.addEventListener('click', () => {
      const price = Number(priceIn.value);
      const qty = Number(qtyIn.value);
      if (!price || price <= 0 || !qty || qty <= 0){ alert('Введите корректную цену и количество'); return }
      mgr.addMultiply(price, qty);
      renderAll();
    });

    btnDiv.addEventListener('click', () => {
      const price = Number(priceIn.value);
      const qty = Number(qtyIn.value);
      if (!price || price <= 0 || !qty || qty <= 0){ alert('Введите корректную цену и количество'); return }
      mgr.addDivideThenSum(price, qty);
      renderAll();
    });

    btnApplyService.addEventListener('click', () => {
      const p = Number(serviceIn.value);
      if (isNaN(p) || p < 0 || p > 100){ alert('Введите корректный процент (0–100)'); return }
      mgr.setService(p);
      renderAll();
    });

    btnResetService.addEventListener('click', () => {
      serviceIn.value = '';
      mgr.setService(0);
      renderAll();
    });

    btnClear.addEventListener('click', () => {
      if (!confirm('Очистить все записи?')) return;
      mgr.clear(); mgr.setService(0);
      priceIn.value = qtyIn.value = serviceIn.value = '';
      renderAll();
    });

    btnCalc.addEventListener('click', () => {
      renderAll();
      alert('Рассчитано — смотрите правую панель');
    });

    [priceIn, qtyIn].forEach(i => i.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { btnMul.click(); }
    }));

    renderAll();
    window.mgr = mgr;
  </script>
</body>
</html>
